# Matches godot4-ios-export setup: https://github.com/dulvui/godot4-ios-export
name: iOS TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GODOT_VERSION: "4.5"
  GODOT_RELEASE: "stable"
  PROJECT_NAME: "buildgodot"
  BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_DIST_P12_BASE64 }}
  P12_PASSWORD: ${{ secrets.IOS_DIST_P12_PASSWORD }}
  BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  IOS_APPSTORE_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
  IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
  IOS_PROVISION_PROFILE_NAME: ${{ secrets.IOS_PROVISION_PROFILE_NAME }}
  IOS_SHORT_VERSION: "1.0"
  IOS_VERSION: "1"

jobs:
  deploy:
    runs-on: macos-14
    timeout-minutes: 60
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Select Xcode 16 (iOS 18 SDK required for App Store)
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Install the Apple certificate and provisioning profile
        run: |
          set -euo pipefail
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > "$PP_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"

          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i "$PP_PATH")")
          cp "$PP_PATH" "$PROFILE_DIR/$PROFILE_UUID.mobileprovision"

      - name: Install Godot editor and templates
        run: |
          set -euo pipefail
          GODOT_DIR="${{ github.workspace }}/.godot"
          mkdir -p "$GODOT_DIR"
          curl -L -o "$GODOT_DIR/godot.zip" "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-${GODOT_RELEASE}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_macos.universal.zip"
          unzip -q "$GODOT_DIR/godot.zip" -d "$GODOT_DIR"
          mv "$GODOT_DIR"/Godot*.app/Contents/MacOS/Godot "$GODOT_DIR/godot"
          chmod +x "$GODOT_DIR/godot"
          curl -L -o "$GODOT_DIR/templates.tpz" "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-${GODOT_RELEASE}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_export_templates.tpz"
          TEMPLATE_DIR="$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.${GODOT_RELEASE}"
          mkdir -p "$TEMPLATE_DIR"
          TEMPLATE_STAGING="$GODOT_DIR/templates"
          mkdir -p "$TEMPLATE_STAGING"
          unzip -q "$GODOT_DIR/templates.tpz" -d "$TEMPLATE_STAGING"
          cp -R "$TEMPLATE_STAGING/templates/." "$TEMPLATE_DIR"

      - name: Create and config export_presets.cfg
        run: |
          set -euo pipefail
          cp export_presets.ios.example export_presets.cfg
          sed -i '' "s|IOS_APPSTORE_TEAM_ID|$IOS_APPSTORE_TEAM_ID|g" export_presets.cfg
          sed -i '' "s|IOS_BUNDLE_ID|$IOS_BUNDLE_ID|g" export_presets.cfg
          sed -i '' "s|IOS_PROVISION_PROFILE_NAME|$IOS_PROVISION_PROFILE_NAME|g" export_presets.cfg
          sed -i '' "s|IOS_SHORT_VERSION|$IOS_SHORT_VERSION|g" export_presets.cfg
          sed -i '' "s|IOS_VERSION|$IOS_VERSION|g" export_presets.cfg

      - name: Export and build IPA
        run: |
          set -euo pipefail
          mkdir -p build
          ./.godot/godot --headless --path . --export-release "iOS"

      - name: Upload to TestFlight
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/private_keys"
          KEY_PATH="$HOME/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8"
          printf "%s" "$APPSTORE_API_PRIVATE_KEY" > "$KEY_PATH"
          xcrun altool --upload-app -f build/${PROJECT_NAME}.ipa -t ios --apiKey "$APPSTORE_API_KEY_ID" --apiIssuer "$APPSTORE_API_ISSUER_ID"
