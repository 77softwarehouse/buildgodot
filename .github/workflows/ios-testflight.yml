name: iOS TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-testflight:
    runs-on: macos-14
    timeout-minutes: 60
    env:
      GODOT_VERSION: "4.5"
      GODOT_RELEASE: "stable"
      IOS_SCHEME: "buildgodot"
      IOS_CONFIGURATION: "Release"
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_PROVISION_PROFILE_NAME: ${{ secrets.IOS_PROVISION_PROFILE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Godot editor and templates
        run: |
          set -euo pipefail
          GODOT_DIR="${{ github.workspace }}/.godot"
          mkdir -p "$GODOT_DIR"
          curl -L -o "$GODOT_DIR/godot.zip" "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-${GODOT_RELEASE}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_macos.universal.zip"
          unzip -q "$GODOT_DIR/godot.zip" -d "$GODOT_DIR"
          mv "$GODOT_DIR"/Godot*.app/Contents/MacOS/Godot "$GODOT_DIR/godot"
          chmod +x "$GODOT_DIR/godot"
          curl -L -o "$GODOT_DIR/templates.tpz" "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-${GODOT_RELEASE}/Godot_v${GODOT_VERSION}-${GODOT_RELEASE}_export_templates.tpz"
          TEMPLATE_DIR="$HOME/Library/Application Support/Godot/export_templates/${GODOT_VERSION}.${GODOT_RELEASE}"
          mkdir -p "$TEMPLATE_DIR"
          TEMPLATE_STAGING="$GODOT_DIR/templates"
          mkdir -p "$TEMPLATE_STAGING"
          unzip -q "$GODOT_DIR/templates.tpz" -d "$TEMPLATE_STAGING"
          cp -R "$TEMPLATE_STAGING/templates/." "$TEMPLATE_DIR"

      - name: Export Xcode project
        run: |
          set -euo pipefail
          mkdir -p build/ios
          ./.godot/godot --headless --path . --export-release "iOS" build/ios/buildgodot.xcodeproj

      - name: Install signing assets
        env:
          IOS_DIST_P12_BASE64: ${{ secrets.IOS_DIST_P12_BASE64 }}
          IOS_DIST_P12_PASSWORD: ${{ secrets.IOS_DIST_P12_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          CERT_PATH="$RUNNER_TEMP/ios_distribution.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          echo "$IOS_DIST_P12_BASE64" | base64 --decode > "$CERT_PATH"
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_DIST_P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"

          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i "$PROFILE_PATH")")
          cp "$PROFILE_PATH" "$PROFILE_DIR/$PROFILE_UUID.mobileprovision"

      - name: Build and archive
        run: |
          set -euo pipefail
          xcodebuild -project build/ios/buildgodot.xcodeproj \
            -scheme "$IOS_SCHEME" \
            -configuration "$IOS_CONFIGURATION" \
            -archivePath build/ios/buildgodot.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROVISION_PROFILE_NAME" \
            PRODUCT_BUNDLE_IDENTIFIER="$IOS_BUNDLE_ID" \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            archive

      - name: Export IPA
        run: |
          set -euo pipefail
          EXPORT_PLIST="$RUNNER_TEMP/exportOptions.plist"
          cat > "$EXPORT_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_BUNDLE_ID}</key>
              <string>${IOS_PROVISION_PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF
          xcodebuild -exportArchive \
            -archivePath build/ios/buildgodot.xcarchive \
            -exportPath build/ios/export \
            -exportOptionsPlist "$EXPORT_PLIST"

      - name: Upload to TestFlight
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/private_keys"
          KEY_PATH="$HOME/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8"
          printf "%s" "$APPSTORE_API_PRIVATE_KEY" > "$KEY_PATH"
          IPA_PATH="build/ios/export/buildgodot.ipa"
          xcrun altool --upload-app -f "$IPA_PATH" -t ios --apiKey "$APPSTORE_API_KEY_ID" --apiIssuer "$APPSTORE_API_ISSUER_ID"
